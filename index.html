<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RN Studio - Business Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RN Studio</h1>
            <p>Professional Photography Business Manager</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('add-event')">Add Event</button>
            <button class="nav-tab" onclick="showTab('events')">View Events</button>
            <button class="nav-tab" onclick="showTab('photographers')">Photographers</button>
            <button class="nav-tab" onclick="showTab('salary-management')">Salary Management</button>
            <button class="nav-tab" onclick="showTab('expense-tracker')">Expense Tracker</button>
            <button class="nav-tab" onclick="showTab('salary-dashboard')">Salary Dashboard</button>
            <button class="nav-tab" onclick="showTab('analytics')">Analytics</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Events</h4>
                    <div class="value" id="totalEvents">0</div>
                </div>
                <div class="stat-card">
                    <h4>Total Revenue</h4>
                    <div class="value" id="totalRevenue">₹0</div>
                </div>
                <div class="stat-card">
                    <h4>Total Expenses</h4>
                    <div class="value" id="totalExpenses">₹0</div>
                </div>
                <div class="stat-card">
                    <h4>Net Profit</h4>
                    <div class="value" id="netProfit">₹0</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Recent Events</h3>
                <table class="data-table" id="recentEventsTable">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Prize</th>
                            <th>Photographer</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentEventsBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #666;">No events found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Event Tab -->
        <div id="add-event" class="tab-content">
            <div class="form-section">
                <h3>Add New Event</h3>
                <form id="eventForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="eventName">Event Name</label>
                            <input type="text" id="eventName" name="eventName" required>
                        </div>
                        <div class="form-group">
                            <label for="eventDate">Event Date</label>
                            <input type="date" id="eventDate" name="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventPrize">Event Prize (₹)</label>
                            <input type="number" id="eventPrize" name="eventPrize" required>
                        </div>
                        <div class="form-group">
                            <label for="eventExpenses">Event Expenses (₹)</label>
                            <input type="number" id="eventExpenses" name="eventExpenses">
                        </div>
                        <div class="form-group">
                            <label for="photographerName">Photographer</label>
                            <select id="photographerName" name="photographerName" required>
                                <option value="">Select Photographer</option>
                                <option value="Self">Self</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="photographerSalary">Photographer Salary (₹)</label>
                            <input type="number" id="photographerSalary" name="photographerSalary">
                        </div>
                        <div class="form-group">
                            <label for="eventDuration">Event Duration (Days)</label>
                            <input type="number" id="eventDuration" name="eventDuration" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="eventType">Event Type</label>
                            <select id="eventType" name="eventType" required>
                                <option value="">Select Type</option>
                                <option value="Wedding">Wedding</option>
                                <option value="Pre-Wedding">Pre-Wedding</option>
                                <option value="Birthday">Birthday</option>
                                <option value="Corporate">Corporate</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Portrait">Portrait</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="eventNotes">Notes</label>
                        <textarea id="eventNotes" name="eventNotes" rows="3" placeholder="Additional notes about the event..."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">Add Event</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Events Tab -->
        <div id="events" class="tab-content">
            <div class="form-section">
                <h3>All Events</h3>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchEvents" placeholder="Search events..." style="padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 5px;">
                    <select id="filterType" style="padding: 10px; margin-left: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">All Types</option>
                        <option value="Wedding">Wedding</option>
                        <option value="Pre-Wedding">Pre-Wedding</option>
                        <option value="Birthday">Birthday</option>
                        <option value="Corporate">Corporate</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Portrait">Portrait</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <table class="data-table" id="eventsTable">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Prize</th>
                            <th>Expenses</th>
                            <th>Photographer</th>
                            <th>Salary</th>
                            <th>Duration</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #666;">No events found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Photographers Tab -->
        <div id="photographers" class="tab-content">
            <div class="form-section">
                <h3>Add Photographer</h3>
                <form id="photographerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="photographerNameAdd">Photographer Name</label>
                            <input type="text" id="photographerNameAdd" name="photographerNameAdd" required>
                        </div>
                        <div class="form-group">
                            <label for="photographerContact">Contact Number</label>
                            <input type="tel" id="photographerContact" name="photographerContact">
                        </div>
                        <div class="form-group">
                            <label for="photographerEmail">Email</label>
                            <input type="email" id="photographerEmail" name="photographerEmail">
                        </div>
                        <div class="form-group">
                            <label for="photographerRate">Daily Rate (₹)</label>
                            <input type="number" id="photographerRate" name="photographerRate">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">Add Photographer</button>
                    </div>
                </form>
            </div>
            
            <div class="form-section">
                <h3>Photographers List</h3>
                <table class="data-table" id="photographersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Daily Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="photographersTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #666;">No photographers found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Average Event Value</h4>
                    <div class="value" id="avgEventValue">₹0</div>
                </div>
                <div class="stat-card">
                    <h4>This Month Revenue</h4>
                    <div class="value" id="monthRevenue">₹0</div>
                </div>
                <div class="stat-card">
                    <h4>Most Popular Event Type</h4>
                    <div class="value" id="popularEventType">-</div>
                </div>
                <div class="stat-card">
                    <h4>Total Event Days</h4>
                    <div class="value" id="totalEventDays">0</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Monthly Revenue Analysis</h3>
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="form-section">
                <h3>Google Sheets Integration</h3>
                <div class="google-sheets-section">
                    <h4>Connection Status: <span class="status-indicator status-disconnected" id="connectionStatus">Disconnected</span></h4>
                    
                    <div class="warning-box">
                        <h5>⚠️ Important Notice</h5>
                        <p>When connecting to Google Sheets for the first time, your local data will be preserved. The system will first upload your existing data to the sheet before enabling synchronization.</p>
                    </div>
                    
                    <p>To connect with Google Sheets, you'll need to:</p>
                    <ol>
                        <li>Create a Google Sheet for your business data</li>
                        <li>Set up Google Apps Script (copy the provided script)</li>
                        <li>Deploy as web app (Execute as: Me, Who has access: Anyone)</li>
                        <li>Enter the web app URL below</li>
                    </ol>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="googleSheetUrl">Google Apps Script Web App URL</label>
                        <input type="url" id="googleSheetUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                    </div>
                    
                    <div class="sync-options">
                        <button class="btn btn-primary" onclick="connectGoogleSheets()">Connect & Upload Data</button>
                        <button class="btn btn-secondary" onclick="syncToGoogleSheets(true)" id="manualSyncBtn" disabled>Manual Sync</button>
                        <button class="btn btn-secondary" onclick="loadFromGoogleSheets()" id="loadFromSheetsBtn" disabled>Load from Sheets</button>
                        <button class="btn btn-danger" onclick="disconnectGoogleSheets()">Disconnect</button>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Data Management</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-secondary" onclick="importData()">Import Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
        
        <div id="salary-management" class="tab-content">
    <div class="form-section">
        <h3>Photographer Attendance & Salary</h3>
        <form id="attendanceForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="attendancePhotographer">Photographer</label>
                    <select id="attendancePhotographer" name="attendancePhotographer" required>
                        <option value="">Select Photographer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceDate">Date</label>
                    <input type="date" id="attendanceDate" name="attendanceDate" required>
                </div>
                <div class="form-group">
                    <label for="attendanceStatus">Status</label>
                    <select id="attendanceStatus" name="attendanceStatus" required>
                        <option value="">Select Status</option>
                        <option value="Present">Present</option>
                        <option value="Absent">Absent</option>
                        <option value="Half-Day">Half-Day</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceNotes">Notes</label>
                    <input type="text" id="attendanceNotes" name="attendanceNotes" placeholder="Optional notes">
                </div>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Mark Attendance</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('attendanceForm').reset()">Clear</button>
            </div>
        </form>
    </div>

    <div class="form-section">
        <h3>Salary Payment</h3>
        <form id="salaryPaymentForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="paymentPhotographer">Photographer</label>
                    <select id="paymentPhotographer" name="paymentPhotographer" required>
                        <option value="">Select Photographer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount (₹)</label>
                    <input type="number" id="paymentAmount" name="paymentAmount" required>
                </div>
                <div class="form-group">
                    <label for="paymentDate">Payment Date</label>
                    <input type="date" id="paymentDate" name="paymentDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentMode">Payment Mode</label>
                    <select id="paymentMode" name="paymentMode" required>
                        <option value="">Select Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentRemarks">Remarks</label>
                    <input type="text" id="paymentRemarks" name="paymentRemarks" placeholder="Optional remarks">
                </div>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Record Payment</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('salaryPaymentForm').reset()">Clear</button>
            </div>
        </form>
    </div>

    <div class="form-section">
        <h3>Attendance Records</h3>
        <div style="margin-bottom: 20px;">
            <select id="attendanceFilterPhotographer" style="padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">All Photographers</option>
            </select>
            <input type="month" id="attendanceFilterMonth" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <table class="data-table" id="attendanceTable">
            <thead>
                <tr>
                    <th>Photographer</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Daily Rate</th>
                    <th>Earnings</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="attendanceTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; color: #666;">No attendance records found</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Expense Tracker Tab -->
<div id="expense-tracker" class="tab-content">
    <div class="form-section">
        <h3>Add Expense</h3>
        <form id="expenseForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" name="expenseDate" required>
                </div>
                <div class="form-group">
                    <label for="expenseCategory">Category</label>
                    <select id="expenseCategory" name="expenseCategory" required>
                        <option value="">Select Category</option>
                        <option value="Travel">Travel</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Props">Props</option>
                        <option value="Food">Food</option>
                        <option value="Editing Tools">Editing Tools</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Miscellaneous">Miscellaneous</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expenseDescription">Description</label>
                    <input type="text" id="expenseDescription" name="expenseDescription" required placeholder="Brief description">
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Amount (₹)</label>
                    <input type="number" id="expenseAmount" name="expenseAmount" required>
                </div>
                <div class="form-group">
                    <label for="expensePaymentMode">Payment Mode</label>
                    <select id="expensePaymentMode" name="expensePaymentMode" required>
                        <option value="">Select Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expenseRemarks">Remarks</label>
                    <input type="text" id="expenseRemarks" name="expenseRemarks" placeholder="Optional remarks">
                </div>
            </div>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Add Expense</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('expenseForm').reset()">Clear</button>
            </div>
        </form>
    </div>

    <div class="form-section">
        <h3>Expense Records</h3>
        <div style="margin-bottom: 20px;">
            <select id="expenseFilterCategory" style="padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">All Categories</option>
                <option value="Travel">Travel</option>
                <option value="Equipment">Equipment</option>
                <option value="Props">Props</option>
                <option value="Food">Food</option>
                <option value="Editing Tools">Editing Tools</option>
                <option value="Marketing">Marketing</option>
                <option value="Miscellaneous">Miscellaneous</option>
            </select>
            <input type="month" id="expenseFilterMonth" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <table class="data-table" id="expenseTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Payment Mode</th>
                    <th>Remarks</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="expenseTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; color: #666;">No expense records found</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Salary Dashboard Tab -->
<div id="salary-dashboard" class="tab-content">
    <div class="stats-grid">
        <div class="stat-card">
            <h4>Total Salary Earned</h4>
            <div class="value" id="totalSalaryEarned">₹0</div>
        </div>
        <div class="stat-card">
            <h4>Total Salary Paid</h4>
            <div class="value" id="totalSalaryPaid">₹0</div>
        </div>
        <div class="stat-card">
            <h4>Outstanding Salary</h4>
            <div class="value" id="outstandingSalary">₹0</div>
        </div>
        <div class="stat-card">
            <h4>Total Expenses</h4>
            <div class="value" id="totalExpensesAmount">₹0</div>
        </div>
    </div>

    <div class="form-section">
        <h3>Photographer Salary Summary</h3>
        <table class="data-table" id="salaryDashboardTable">
            <thead>
                <tr>
                    <th>Photographer</th>
                    <th>Days Worked</th>
                    <th>Total Earned</th>
                    <th>Total Paid</th>
                    <th>Outstanding</th>
                    <th>Last Payment</th>
                </tr>
            </thead>
            <tbody id="salaryDashboardTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; color: #666;">No salary data found</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="form-section">
        <h3>Monthly Expense Breakdown</h3>
        <div class="expense-breakdown" id="expenseBreakdown">
            <p style="text-align: center; color: #666;">No expense data found</p>
            </div>
         </div>
       </div>

    </div>

    <script>
        // Data storage
        let events = JSON.parse(localStorage.getItem('rn_studio_events')) || [];
        let photographers = JSON.parse(localStorage.getItem('rn_studio_photographers')) || [
            {id: 1, name: 'Self', contact: '', email: '', rate: 0}
        ];
        let isConnectedToSheets = false;
        let sheetsUrl = '';

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Update data when switching tabs
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'events') {
                loadEvents();
            } else if (tabName === 'photographers') {
                loadPhotographers();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Event form submission
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const eventData = {
                id: Date.now(),
                name: formData.get('eventName'),
                date: formData.get('eventDate'),
                prize: parseFloat(formData.get('eventPrize')),
                expenses: parseFloat(formData.get('eventExpenses')) || 0,
                photographer: formData.get('photographerName'),
                salary: parseFloat(formData.get('photographerSalary')) || 0,
                duration: parseInt(formData.get('eventDuration')),
                type: formData.get('eventType'),
                notes: formData.get('eventNotes'),
                profit: parseFloat(formData.get('eventPrize')) - (parseFloat(formData.get('eventExpenses')) || 0) - (parseFloat(formData.get('photographerSalary')) || 0)
            };
            
            events.push(eventData);
            saveDataLocally();
            
            // Auto-sync if connected
            if (isConnectedToSheets) {
                syncToGoogleSheets();
            }
            
            showNotification('Event added successfully!', 'success');
            clearForm();
            updateDashboard();
        });

        // Photographer form submission
        document.getElementById('photographerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const photographerData = {
                id: Date.now(),
                name: formData.get('photographerNameAdd'),
                contact: formData.get('photographerContact'),
                email: formData.get('photographerEmail'),
                rate: parseFloat(formData.get('photographerRate')) || 0
            };
            
            photographers.push(photographerData);
            saveDataLocally();
            
            // Auto-sync if connected
            if (isConnectedToSheets) {
                syncToGoogleSheets();
            }
            
            // Update photographer dropdown
            updatePhotographerDropdown();
            
            showNotification('Photographer added successfully!', 'success');
            document.getElementById('photographerForm').reset();
            loadPhotographers();
        });

        // Save data to localStorage
        function saveDataLocally() {
            localStorage.setItem('rn_studio_events', JSON.stringify(events));
            localStorage.setItem('rn_studio_photographers', JSON.stringify(photographers));
        }

        // Update photographer dropdown
        function updatePhotographerDropdown() {
            const select = document.getElementById('photographerName');
            select.innerHTML = '<option value="">Select Photographer</option>';
            
            photographers.forEach(photographer => {
                const option = document.createElement('option');
                option.value = photographer.name;
                option.textContent = photographer.name;
                select.appendChild(option);
            });
        }

        // Load events table
        function loadEvents() {
            const tbody = document.getElementById('eventsTableBody');
            tbody.innerHTML = '';
            
            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No events found</td></tr>';
                return;
            }
            
            events.forEach(event => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${event.name}</td>
                    <td>${new Date(event.date).toLocaleDateString()}</td>
                    <td>${event.type}</td>
                    <td>₹${event.prize.toLocaleString()}</td>
                    <td>₹${event.expenses.toLocaleString()}</td>
                    <td>${event.photographer}</td>
                    <td>₹${event.salary.toLocaleString()}</td>
                    <td>${event.duration} days</td>
                    <td style="color: ${event.profit >= 0 ? 'green' : 'red'}">₹${event.profit.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteEvent(${event.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load photographers table
        function loadPhotographers() {
            const tbody = document.getElementById('photographersTableBody');
            tbody.innerHTML = '';
            
            if (photographers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No photographers found</td></tr>';
                return;
            }
            
            photographers.forEach(photographer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${photographer.name}</td>
                    <td>${photographer.contact}</td>
                    <td>${photographer.email}</td>
                    <td>₹${photographer.rate.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deletePhotographer(${photographer.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update dashboard
        function updateDashboard() {
            const totalEvents = events.length;
            const totalRevenue = events.reduce((sum, event) => sum + event.prize, 0);
            const totalExpenses = events.reduce((sum, event) => sum + event.expenses + event.salary, 0);
            const netProfit = totalRevenue - totalExpenses;
            
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('totalRevenue').textContent = '₹' + totalRevenue.toLocaleString();
            document.getElementById('totalExpenses').textContent = '₹' + totalExpenses.toLocaleString();
            document.getElementById('netProfit').textContent = '₹' + netProfit.toLocaleString();
            
            // Update recent events
            const recentEvents = events.slice(-5).reverse();
            const tbody = document.getElementById('recentEventsBody');
            tbody.innerHTML = '';
            
            if (recentEvents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No events found</td></tr>';
            } else {
                recentEvents.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${event.name}</td>
                        <td>${new Date(event.date).toLocaleDateString()}</td>
                        <td>₹${event.prize.toLocaleString()}</td>
                        <td>${event.photographer}</td>
                        <td><span class="status-indicator status-connected">Completed</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Update analytics
        function updateAnalytics() {
            const avgEventValue = events.length > 0 ? events.reduce((sum, event) => sum + event.prize, 0) / events.length : 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthRevenue = events.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear;
            }).reduce((sum, event) => sum + event.prize, 0);
            
            const eventTypes = {};
            events.forEach(event => {
                eventTypes[event.type] = (eventTypes[event.type] || 0) + 1;
            });
            
            const popularEventType = Object.keys(eventTypes).length > 0 ? 
                Object.keys(eventTypes).reduce((a, b) => eventTypes[a] > eventTypes[b] ? a : b) : '-';
            
            const totalEventDays = events.reduce((sum, event) => sum + event.duration, 0);
            
            document.getElementById('avgEventValue').textContent = '₹' + Math.round(avgEventValue).toLocaleString();
            document.getElementById('monthRevenue').textContent = '₹' + monthRevenue.toLocaleString();
            document.getElementById('popularEventType').textContent = popularEventType;
            document.getElementById('totalEventDays').textContent = totalEventDays;
        }

        // Utility functions
        function clearForm() {
            document.getElementById('eventForm').reset();
        }

        function deleteEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                events = events.filter(event => event.id !== id);
                localStorage.setItem('rn_studio_events', JSON.stringify(events));
                loadEvents();
                updateDashboard();
            }
        }

        function deletePhotographer(id) {
            if (confirm('Are you sure you want to delete this photographer?')) {
                photographers = photographers.filter(photographer => photographer.id !== id);
                localStorage.setItem('rn_studio_photographers', JSON.stringify(photographers));
                updatePhotographerDropdown();
                loadPhotographers();
            }
        }

        // Search and filter functions
        document.getElementById('searchEvents').addEventListener('input', function() {
            filterEvents();
        });

        document.getElementById('filterType').addEventListener('change', function() {
            filterEvents();
        });

        function filterEvents() {
            const searchTerm = document.getElementById('searchEvents').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            
            let filteredEvents = events;
            
            if (searchTerm) {
                filteredEvents = filteredEvents.filter(event => 
                    event.name.toLowerCase().includes(searchTerm) ||
                    event.photographer.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filterType) {
                filteredEvents = filteredEvents.filter(event => event.type === filterType);
            }
            
            displayFilteredEvents(filteredEvents);
        }

        function displayFilteredEvents(filteredEvents) {
            const tbody = document.getElementById('eventsTableBody');
            tbody.innerHTML = '';
            
            if (filteredEvents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No events found</td></tr>';
                return;
            }
            
            filteredEvents.forEach(event => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${event.name}</td>
                    <td>${new Date(event.date).toLocaleDateString()}</td>
                    <td>${event.type}</td>
                    <td>₹${event.prize.toLocaleString()}</td>
                    <td>₹${event.expenses.toLocaleString()}</td>
                    <td>${event.photographer}</td>
                    <td>₹${event.salary.toLocaleString()}</td>
                    <td>${event.duration} days</td>
                    <td style="color: ${event.profit >= 0 ? 'green' : 'red'}">₹${event.profit.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteEvent(${event.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Google Sheets integration
        function connectGoogleSheets() {
    const url = document.getElementById('googleSheetUrl').value;
    if (!url) {
        alert('Please enter the Google Apps Script URL');
        return;
    }
    
    // Store the URL
    localStorage.setItem('rn_studio_sheets_url', url);
    sheetsUrl = url;
    
    // First check if data already exists in sheets
    checkSheetsData().then(hasData => {
        if (hasData) {
            // Data exists in sheets, ask user what to do
            const choice = confirm(
                'Data already exists in Google Sheets. Click OK to load data from sheets, or Cancel to upload your local data to sheets.'
            );
            
            if (choice) {
                // Load from sheets
                loadFromGoogleSheets();
            } else {
                // Upload local data to sheets
                uploadLocalDataToSheets();
            }
        } else {
            // No data in sheets, upload local data
            uploadLocalDataToSheets();
        }
        
        // Update UI
        updateConnectionStatus(true);
    }).catch(error => {
        console.error('Error connecting to Google Sheets:', error);
        // Still mark as connected for sync purposes
        updateConnectionStatus(true);
        // Upload local data as fallback
        uploadLocalDataToSheets();
    });
}
function checkSheetsData() {
    return new Promise((resolve, reject) => {
        const url = localStorage.getItem('rn_studio_sheets_url');
        if (!url) {
            reject('No URL configured');
            return;
        }
        
        const callback = 'checkDataCallback' + Date.now();
        
        // Create JSONP callback
        window[callback] = function(data) {
            resolve(data.hasData);
            delete window[callback];
            document.body.removeChild(script);
        };
        
        // Create script tag for JSONP
        const script = document.createElement('script');
        script.src = url + '?action=checkData&callback=' + callback;
        script.onerror = () => {
            reject('Failed to check sheets data');
            delete window[callback];
            document.body.removeChild(script);
        };
        
        document.body.appendChild(script);
    });
}

function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connectionStatus');
    const manualSyncBtn = document.getElementById('manualSyncBtn');
    const loadFromSheetsBtn = document.getElementById('loadFromSheetsBtn');
    
    if (connected) {
        statusElement.textContent = 'Connected';
        statusElement.className = 'status-indicator status-connected';
        manualSyncBtn.disabled = false;
        loadFromSheetsBtn.disabled = false;
        isConnectedToSheets = true;
        showNotification('Connected to Google Sheets successfully!', 'success');
    } else {
        statusElement.textContent = 'Disconnected';
        statusElement.className = 'status-indicator status-disconnected';
        manualSyncBtn.disabled = true;
        loadFromSheetsBtn.disabled = true;
        isConnectedToSheets = false;
    }
}

function uploadLocalDataToSheets() {
    if (events.length === 0 && photographers.length <= 1) {
        showNotification('No local data to upload', 'info');
        return;
    }
    
    showNotification('Uploading local data to Google Sheets...', 'info');
    syncToGoogleSheets(false, true); // false = no manual notification, true = initial upload
}

        // Data management functions
        function exportData() {
            const data = {
                events: events,
                photographers: photographers,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'rn_studio_backup_' + new Date().toISOString().split('T')[0] + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.events && data.photographers) {
                            if (confirm('This will replace all current data. Are you sure?')) {
                                events = data.events;
                                photographers = data.photographers;
                                localStorage.setItem('rn_studio_events', JSON.stringify(events));
                                localStorage.setItem('rn_studio_photographers', JSON.stringify(photographers));
                                updatePhotographerDropdown();
                                updateDashboard();
                                alert('Data imported successfully!');
                            }
                        } else {
                            alert('Invalid backup file format.');
                        }
                    } catch (error) {
                        alert('Error reading backup file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('This will permanently delete all your data. Are you sure?')) {
                if (confirm('Last chance! This action cannot be undone.')) {
                    events = [];
                    photographers = [{id: 1, name: 'Self', contact: '', email: '', rate: 0}];
                    localStorage.setItem('rn_studio_events', JSON.stringify(events));
                    localStorage.setItem('rn_studio_photographers', JSON.stringify(photographers));
                    updatePhotographerDropdown();
                    updateDashboard();
                    loadEvents();
                    loadPhotographers();
                    alert('All data cleared successfully!');
                }
            }
        }

        function syncToGoogleSheets(manual = false, initialUpload = false) {
    const url = localStorage.getItem('rn_studio_sheets_url');
    if (!url) {
        if (manual) {
            showNotification('Google Sheets not configured', 'error');
        }
        return;
    }
    
    // Create hidden iframe to prevent page navigation
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.name = 'syncFrame';
    document.body.appendChild(iframe);
    
    // Use form submission to hidden iframe
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    form.target = 'syncFrame';
    form.style.display = 'none';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'sync';
    form.appendChild(actionInput);
    
    const eventsInput = document.createElement('input');
    eventsInput.type = 'hidden';
    eventsInput.name = 'events';
    eventsInput.value = JSON.stringify(events);
    form.appendChild(eventsInput);
    
    const photographersInput = document.createElement('input');
    photographersInput.type = 'hidden';
    photographersInput.name = 'photographers';
    photographersInput.value = JSON.stringify(photographers);
    form.appendChild(photographersInput);
    
    document.body.appendChild(form);
    form.submit();
    
    // Clean up after a delay
    setTimeout(() => {
        if (document.body.contains(form)) document.body.removeChild(form);
        if (document.body.contains(iframe)) document.body.removeChild(iframe);
    }, 2000);
    
    // Show appropriate notification
    if (manual) {
        showNotification('Data synced to Google Sheets!', 'success');
    } else if (initialUpload) {
        showNotification('Local data uploaded to Google Sheets!', 'success');
    }
}
        // Auto-sync when data changes
        function saveAndSync() {
            localStorage.setItem('rn_studio_events', JSON.stringify(events));
            localStorage.setItem('rn_studio_photographers', JSON.stringify(photographers));
            syncToGoogleSheets();
        }

        // Enhanced form validation
        document.getElementById('eventForm').addEventListener('input', function(e) {
            const target = e.target;
            if (target.name === 'photographerName' && target.value) {
                const photographer = photographers.find(p => p.name === target.value);
                if (photographer && photographer.rate > 0) {
                    document.getElementById('photographerSalary').value = photographer.rate;
                }
            }
        });


        // Load data from Google Sheets
function loadFromGoogleSheets() {
    return new Promise((resolve, reject) => {
        const url = localStorage.getItem('rn_studio_sheets_url');
        if (!url) {
            reject('Google Sheets not configured');
            return;
        }
        
        const callback = 'loadDataCallback' + Date.now();
        
        // Create JSONP callback
        window[callback] = function(data) {
            try {
                if (data.events && data.photographers) {
                    events = data.events;
                    photographers = data.photographers;
                    saveDataLocally();
                    updatePhotographerDropdown();
                    updateDashboard();
                    loadEvents();
                    loadPhotographers();
                    showNotification('Data loaded from Google Sheets successfully!', 'success');
                    resolve(data);
                } else {
                    reject('Invalid data format');
                }
            } catch (error) {
                reject('Error processing data: ' + error.message);
            }
            
            delete window[callback];
            document.body.removeChild(script);
        };
        
        // Create script tag for JSONP
        const script = document.createElement('script');
        script.src = url + '?action=load&callback=' + callback;
        script.onerror = () => {
            reject('Failed to load data from Google Sheets');
            delete window[callback];
            if (document.body.contains(script)) {
                document.body.removeChild(script);
            }
        };
        
        document.body.appendChild(script);
    });
}        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        showTab('add-event');
                        break;
                    case 'e':
                        e.preventDefault();
                        exportData();
                        break;
                    case 's':
                        e.preventDefault();
                        syncToGoogleSheets();
                        break;
                }
            }
        });

function initializeApp() {
    updatePhotographerDropdown();
    updateDashboard();
    
    // Check for Google Sheets connection
    const storedSheetsUrl = localStorage.getItem('rn_studio_sheets_url');
    if (storedSheetsUrl) {
        document.getElementById('googleSheetUrl').value = storedSheetsUrl;
        sheetsUrl = storedSheetsUrl;
        updateConnectionStatus(true);
        
        // Don't automatically load from sheets on startup
        // Let user decide when to sync
        console.log('Google Sheets URL found, ready for manual sync');
    }
}
        // Auto-save every 5 minutes (300000 ms) - less annoying
setInterval(() => {
    localStorage.setItem('rn_studio_events', JSON.stringify(events));
    localStorage.setItem('rn_studio_photographers', JSON.stringify(photographers));
    syncToGoogleSheets(); // No notification for auto-sync
}, 300000);

        // Initialize when page loads
        window.addEventListener('load', initializeApp);
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            saveAndSync();
        });

        // Add notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
                ${type === 'success' ? 'background: #28a745;' : 
                  type === 'error' ? 'background: #dc3545;' : 
                  'background: #17a2b8;'}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Application error:', e);
            showNotification('An error occurred. Please try again.', 'error');
        });
        
        // Service worker registration for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }
        // Disconnect Google Sheets
        function disconnectGoogleSheets() {
    if (confirm('Are you sure you want to disconnect from Google Sheets?')) {
        localStorage.removeItem('rn_studio_sheets_url');
        sheetsUrl = '';
        document.getElementById('googleSheetUrl').value = '';
        updateConnectionStatus(false);
        showNotification('Disconnected from Google Sheets', 'info');
    }
}
    </script>
</body>
</html>
